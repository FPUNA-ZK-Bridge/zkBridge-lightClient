# BLS Signature Split Verifiers

This directory contains the verifier contracts for the 3-part BLS signature verification split.

## File Structure

- `VerifierPart1.sol` - Verifier for Part1 (Checks + MapToG2) - 98 public signals
- `VerifierPart2.sol` - Verifier for Part2 (MillerLoop) - 154 public signals  
- `VerifierPart3.sol` - Verifier for Part3 (FinalExp) - 84 public signals
- `BlsSignatureSplitVerifier.sol` - Wrapper that verifies all 3 proofs and chains them

## Generating Verifiers

The verifier contracts (`VerifierPart1.sol`, `VerifierPart2.sol`, `VerifierPart3.sol`) are auto-generated by `snarkjs` from the compiled circuits.

### Prerequisites

1. Compile the circuits:
```bash
cd circuits/utils/circom-pairing/scripts/signature

# Part 1
circom signature_part1.circom --r1cs --wasm --sym -o ../../build/part1

# Part 2
circom signature_part2.circom --r1cs --wasm --sym -o ../../build/part2

# Part 3
circom signature_part3.circom --r1cs --wasm --sym -o ../../build/part3
```

2. Generate zkeys (requires powersOfTau file):
```bash
# Part 1
snarkjs groth16 setup ../../build/part1/signature_part1.r1cs powersOfTau28_hez_final_27.ptau part1_0000.zkey
snarkjs zkey contribute part1_0000.zkey part1_final.zkey --name="contrib" -v

# Part 2
snarkjs groth16 setup ../../build/part2/signature_part2.r1cs powersOfTau28_hez_final_27.ptau part2_0000.zkey
snarkjs zkey contribute part2_0000.zkey part2_final.zkey --name="contrib" -v

# Part 3
snarkjs groth16 setup ../../build/part3/signature_part3.r1cs powersOfTau28_hez_final_27.ptau part3_0000.zkey
snarkjs zkey contribute part3_0000.zkey part3_final.zkey --name="contrib" -v
```

3. Export Solidity verifiers:
```bash
snarkjs zkey export solidityverifier part1_final.zkey ../../../contracts/src/verifiers/VerifierPart1.sol
snarkjs zkey export solidityverifier part2_final.zkey ../../../contracts/src/verifiers/VerifierPart2.sol
snarkjs zkey export solidityverifier part3_final.zkey ../../../contracts/src/verifiers/VerifierPart3.sol
```

## Public Signals Layout

### Part1 (98 elements)
- `signals[0:28]` = Hm[2][2][7] (output)
- `signals[28:42]` = pubkey[2][7]
- `signals[42:70]` = signature[2][2][7]
- `signals[70:98]` = hash[2][2][7]

### Part2 (154 elements)
- `signals[0:84]` = miller_out[6][2][7] (output)
- `signals[84:98]` = pubkey[2][7]
- `signals[98:126]` = signature[2][2][7]
- `signals[126:154]` = Hm[2][2][7]

### Part3 (84 elements)
- `signals[0:84]` = miller_out[6][2][7]

## Chain Verification

The `BlsSignatureSplitVerifier` contract verifies:

1. **Hm chain**: `Part1[0:28] == Part2[126:154]`
2. **miller_out chain**: `Part2[0:84] == Part3[0:84]`
3. **Consistency**: `Part1[28:70] == Part2[84:126]` (pubkey + signature)

All comparisons use `keccak256` for gas efficiency (~16x savings vs element-by-element comparison).


